#cloud-config
# NEXUS Plugin VM - SOC 2 Type II Compliant Execution Environment
#
# This cloud-init configuration provisions a secure Ubuntu VM with:
# - Docker for container isolation
# - Security hardening
# - Audit logging
# - Network isolation
# - Resource limits

# System packages
packages:
  - docker.io
  - docker-compose
  - git
  - curl
  - jq
  - auditd
  - ufw

# Create nexus user with restricted permissions
users:
  - name: nexus
    groups: docker
    shell: /bin/bash
    sudo: false

# Configure firewall (deny all except Docker)
runcmd:
  # Enable and configure firewall
  - ufw default deny incoming
  - ufw default deny outgoing
  - ufw allow out 53/tcp
  - ufw allow out 53/udp
  - ufw allow out 80/tcp
  - ufw allow out 443/tcp
  - ufw --force enable

  # Enable audit logging for SOC 2 compliance
  - systemctl enable auditd
  - systemctl start auditd
  - auditctl -w /var/run/docker.sock -p wa -k docker

  # Harden Docker daemon
  - mkdir -p /etc/docker
  - |
    cat > /etc/docker/daemon.json <<EOF
    {
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "10m",
        "max-file": "3"
      },
      "live-restore": true,
      "userland-proxy": false,
      "no-new-privileges": true
    }
    EOF
  - systemctl restart docker

  # Set resource limits
  - |
    cat >> /etc/security/limits.conf <<EOF
    nexus soft nofile 1024
    nexus hard nofile 2048
    nexus soft nproc 512
    nexus hard nproc 1024
    EOF

  # Disable unnecessary services
  - systemctl disable snapd
  - systemctl stop snapd

  # Build NEXUS Docker image
  - su - nexus -c "cd /home/nexus && git clone https://github.com/Garrett-s-Apps/nexus-plugin.git"
  - su - nexus -c "cd /home/nexus/nexus-plugin && docker build -t nexus-cli-sandbox ./docker"

# Write Docker container security policy
write_files:
  - path: /etc/docker/seccomp.json
    content: |
      {
        "defaultAction": "SCMP_ACT_ERRNO",
        "architectures": ["SCMP_ARCH_X86_64", "SCMP_ARCH_AARCH64"],
        "syscalls": [
          {
            "names": ["read", "write", "open", "close", "stat", "fstat", "lstat", "execve", "exit_group"],
            "action": "SCMP_ACT_ALLOW"
          }
        ]
      }

# Final message
final_message: "NEXUS VM ready - SOC 2 Type II compliant execution environment"
